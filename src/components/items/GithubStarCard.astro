---
import { pluralise } from "../../helpers/words";
import type { CollectionEntry } from "astro:content";

const { item: star } = Astro.props as {
  item: CollectionEntry<"github-stars">["data"];
};

const hasSensibleDescription = Boolean(
  star.description && star.description.length > 1,
);

const yearsOld =
  new Date().getFullYear() - new Date(star.created_at).getFullYear();
const isAnniversary =
  yearsOld > 0 &&
  new Date().getMonth() === new Date(star.created_at).getMonth();
const isNew =
  yearsOld === 0 &&
  new Date().getMonth() === new Date(star.created_at).getMonth();

// Generate stable pseudo-random values based on star ID for consistent animations
const hashCode = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash);
};

const hash = hashCode(star.id.toString());
const animationDelay = ((hash % 100) / 100 + 0.1).toFixed(2);
const animationDuration = (((hash >> 8) % 100) / 100 + 0.1).toFixed(2);
---

<li
  class="expand-clickable-area shadow border rounded flex flex-col bg-white/50"
>
  <a
    href={star.html_url}
    class="text-binding-dark bg-graph-paper font-bold font-mono p-4 flex-1"
    title={hasSensibleDescription ? star.description : undefined}
  >
    {star.full_name}
  </a>
  {
    hasSensibleDescription && (
      <div class="p-4 border-t border-black">
        <div
          class="github-star-card__title text-xs space-y-2 truncate"
          style={{
            "animation-delay": `${animationDelay}s`,
            "animation-duration": `${animationDuration}s`,
          }}
          title={star.description}
        >
          <div class="block">
            {star.stargazers_count > 0 && (
              <span>â˜… {star.stargazers_count.toLocaleString()}</span>
            )}
            {star.language && (
              <>
                <span>Â·</span>
                <span>{star.language}</span>
              </>
            )}
            {isAnniversary && (
              <>
                <span>Â·</span>
                <span>ðŸŽ‚ {pluralise(yearsOld, "year")} old this month</span>
              </>
            )}
            {isNew && (
              <>
                <span>Â·</span>
                <picture>
                  <source
                    srcset="https://blob.gifcities.org/gifcities/6NFRXRAUIROWRTRZ5BINOLPSBRDPTK6E.gif"
                    media="(prefers-reduced-motion: no-preference)"
                  />
                  <img class="inline h-3.5" src="new.webp" alt="New" />
                </picture>
              </>
            )}
          </div>
          <span class="block truncate">{star.description}</span>
        </div>
      </div>
    )
  }
</li>

<style is:global>
  @media (prefers-reduced-motion: no-preference) {
    [data-in-view="true"]:not([data-in-view-previously="true"])
      .github-star-card__title {
      animation: var(--animate-typewriter);
    }
  }
</style>
